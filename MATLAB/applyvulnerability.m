function [loss, RepairCostbyST, RepairCostbyBLDG] = applyvulnerability(exposure, hazard, probDS, vulnerability)

loss = struct;
loss.era = exposure.era;
loss.index = probDS.index;
loss.Ratio = zeros(numel(exposure.Name),size(vulnerability.mapping,1),numel(hazard.returnperiod));

[unitcost] = loadunitcost();
building_cost = repmat((exposure.Area.stht .* repmat(repmat(unitcost.value,[7,1])',[numel(exposure.Name), 1])), [1,1,8]);

loss.median = reshape(  vulnerability.median(loss.index,1),[85482,80]);
loss.beta = reshape(    vulnerability.beta(loss.index,1),[85482,80]);
loss.Ratio = logncdf(   repmat(reshape(hazard.MMI.mean,[85482,1,8]),[1,80,1]),...
                        log(loss.median),...
                        loss.beta); 

% Determine the Repair Cost
RepairCostbyST = loss.Ratio .* building_cost(:,1:80,:);
RepairCostbyBLDG = sum(RepairCostbyST,2);

end

